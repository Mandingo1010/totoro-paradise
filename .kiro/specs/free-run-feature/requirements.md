# 自由跑功能需求文档

## 介绍

本文档定义了在现有Totoro Paradise项目基础上，新增"自由跑"功能的需求。自由跑功能允许用户模拟提交自定义距离和时间的跑步记录，不受固定路线限制。

## 术语表

- **自由跑 (Free Run)**: 用户可以自定义距离、时间和速度的跑步模式，区别于固定路线的"阳光跑"
- **龙猫服务器 (Totoro Server)**: 目标学校运动应用的后端服务器
- **跑步记录 (Run Record)**: 包含距离、时间、速度、卡路里等信息的跑步数据
- **API包装器 (API Wrapper)**: 封装与龙猫服务器通信的客户端类
- **数据伪造 (Data Forgery)**: 生成符合真实跑步特征的虚假运动数据

## 需求

### 需求 0 (技术调研 - 关键前置条件)

**用户故事:** 作为开发者，我需要从零开始逆向工程龙猫校园的自由跑功能，因为现有代码中没有真实的自由跑API实现，这样才能正确地模拟和提交自由跑数据。

**重要说明:** 现有项目中的自由跑相关代码（如`totoro-paradise-main`目录中的实现）是推测性的，并非基于真实的API逆向分析。所有真实的API端点都只针对阳光跑功能。

#### 验收标准

1. WHEN 进行API逆向工程 THEN 系统 SHALL 识别龙猫校园自由跑功能的真实API端点
2. WHEN 分析网络请求 THEN 系统 SHALL 确定自由跑数据的请求格式和必需字段
3. WHEN 对比阳光跑API THEN 系统 SHALL 识别自由跑与阳光跑在数据结构上的差异
4. WHEN 测试加密方式 THEN 系统 SHALL 验证自由跑是否使用相同的RSA加密算法
5. WHEN 验证响应格式 THEN 系统 SHALL 确认自由跑API的成功和错误响应结构

### 需求 1

**用户故事:** 作为学生用户，我想要选择自由跑模式，这样我可以自定义跑步距离和目标时间。

#### 验收标准

1. WHEN 用户访问跑步模式选择页面 THEN 系统 SHALL 显示"阳光跑"和"自由跑"两个选项
2. WHEN 用户选择自由跑模式 THEN 系统 SHALL 跳转到自由跑参数设置页面
3. WHEN 用户在自由跑页面设置参数 THEN 系统 SHALL 验证距离范围在0.5-20公里之间
4. WHEN 用户设置目标时间 THEN 系统 SHALL 验证平均速度在3-25公里/小时范围内
5. WHEN 参数验证通过 THEN 系统 SHALL 启用"开始跑步"按钮

### 需求 2

**用户故事:** 作为学生用户，我想要系统自动生成真实的跑步数据，这样提交的记录看起来更加可信。

#### 验收标准

1. WHEN 系统生成自由跑数据 THEN 系统 SHALL 根据距离和速度计算准确的用时
2. WHEN 系统计算平均配速 THEN 系统 SHALL 使用分钟:秒格式显示每公里用时
3. WHEN 系统生成卡路里数据 THEN 系统 SHALL 基于距离、速度和标准体重计算消耗
4. WHEN 系统生成步数数据 THEN 系统 SHALL 基于距离使用每公里1200±50步的随机值
5. WHEN 系统生成设备信息 THEN 系统 SHALL 创建基于学号的唯一MAC地址

### 需求 3

**用户故事:** 作为学生用户，我想要系统模拟真实的跑步过程，这样可以避免被检测为异常提交。

#### 验收标准

1. WHEN 用户点击开始跑步 THEN 系统 SHALL 显示倒计时进度条和剩余时间
2. WHEN 跑步进行中 THEN 系统 SHALL 每秒更新进度显示
3. WHEN 用户尝试离开页面 THEN 系统 SHALL 显示确认对话框防止意外退出
4. WHEN 跑步时间结束 THEN 系统 SHALL 自动提交数据到龙猫服务器
5. WHEN 数据提交成功 THEN 系统 SHALL 显示跑步完成确认信息

### 需求 4

**用户故事:** 作为学生用户，我想要查看我的自由跑历史记录，这样我可以了解已完成的跑步情况。

#### 验收标准

1. WHEN 用户访问跑步记录页面 THEN 系统 SHALL 显示阳光跑和自由跑的分类标签
2. WHEN 用户选择自由跑标签 THEN 系统 SHALL 显示所有自由跑记录列表
3. WHEN 显示记录列表 THEN 系统 SHALL 包含日期、距离、用时、平均速度和卡路里信息
4. WHEN 用户点击具体记录 THEN 系统 SHALL 显示该次跑步的详细信息
5. WHEN 记录为空 THEN 系统 SHALL 显示"暂无自由跑记录"提示信息

### 需求 5

**用户故事:** 作为系统管理员，我想要系统正确处理与龙猫服务器的通信，这样可以确保数据成功提交到真实的自由跑API端点。

#### 验收标准

1. WHEN 系统提交自由跑数据 THEN 系统 SHALL 使用通过逆向工程确定的真实API端点
2. WHEN 系统发送请求 THEN 系统 SHALL 使用与龙猫校园自由跑相同的加密和认证方式
3. WHEN 系统构造请求体 THEN 系统 SHALL 严格按照真实API的数据格式和字段要求
4. WHEN 网络请求失败 THEN 系统 SHALL 显示错误信息并允许用户重试
5. WHEN 服务器返回错误 THEN 系统 SHALL 正确解析龙猫服务器的错误响应格式

### 需求 6

**用户故事:** 作为开发者，我想要系统具有良好的代码结构，这样便于维护和扩展功能。

#### 验收标准

1. WHEN 添加自由跑功能 THEN 系统 SHALL 复用现有的加密和网络通信模块
2. WHEN 创建新的API端点 THEN 系统 SHALL 遵循现有的命名和结构约定
3. WHEN 定义数据类型 THEN 系统 SHALL 使用TypeScript接口确保类型安全
4. WHEN 实现业务逻辑 THEN 系统 SHALL 将数据生成、验证和提交逻辑分离
5. WHEN 处理错误情况 THEN 系统 SHALL 提供详细的错误信息和恢复建议

### 需求 7

**用户故事:** 作为学生用户，我想要系统支持批量提交功能，这样我可以一次性完成多次跑步记录。

#### 验收标准

1. WHEN 用户选择批量模式 THEN 系统 SHALL 显示批量设置界面
2. WHEN 用户设置批量参数 THEN 系统 SHALL 验证总次数在1-10次范围内
3. WHEN 用户设置时间间隔 THEN 系统 SHALL 验证间隔时间在1-60分钟范围内
4. WHEN 批量执行开始 THEN 系统 SHALL 为每次跑步生成不同的随机参数
5. WHEN 批量执行过程中 THEN 系统 SHALL 显示当前进度和剩余次数

### 需求 8

**用户故事:** 作为学生用户，我想要系统提供预设模板，这样我可以快速选择常用的跑步配置。

#### 验收标准

1. WHEN 用户进入自由跑设置 THEN 系统 SHALL 显示预设模板选项
2. WHEN 系统提供预设模板 THEN 系统 SHALL 包含"轻松跑"、"标准跑"、"挑战跑"三种模式
3. WHEN 用户选择轻松跑模板 THEN 系统 SHALL 设置3公里距离和6-8公里/小时速度
4. WHEN 用户选择标准跑模板 THEN 系统 SHALL 设置5公里距离和8-12公里/小时速度
5. WHEN 用户选择挑战跑模板 THEN 系统 SHALL 设置10公里距离和10-15公里/小时速度

## 技术调研计划

### 阶段1: API端点发现
- 使用网络抓包工具（如Charles、Fiddler、mitmproxy）监控龙猫校园应用
- 在真实设备上执行自由跑功能，记录所有网络请求
- 识别自由跑专用的API端点路径

### 阶段2: 数据格式分析
- 分析自由跑请求的完整数据结构
- 对比自由跑与阳光跑的数据字段差异
- 确定哪些字段是必需的，哪些是可选的

### 阶段3: 加密验证
- 验证自由跑是否使用相同的RSA加密
- 测试现有的加密密钥是否适用于自由跑
- 确认请求头和认证方式是否一致

### 阶段4: 响应格式确认
- 记录成功提交自由跑后的服务器响应
- 分析错误情况下的响应格式
- 确定如何判断提交是否成功

### 风险评估
- **极高风险**: 自由跑可能使用完全不同的API架构、加密方式或认证机制
- **高风险**: 如果龙猫校园检测到异常的API调用模式，可能会封禁账号
- **中风险**: 自由跑的数据验证规则可能与阳光跑完全不同
- **技术风险**: 没有现成的逆向工程基础，需要从零开始分析

### 前置条件
- 需要有真实的龙猫校园账号进行测试
- 需要安装和配置网络抓包工具
- 需要Android/iOS设备或模拟器运行龙猫校园应用
- 需要具备网络协议分析和加密算法逆向的技术能力

### 备选方案
如果无法找到真实的自由跑API端点，考虑以下方案：
1. 尝试通过阳光跑API提交自由跑数据（使用特殊的runType或其他标识）
2. 寻找其他可能的API端点（如通用的运动记录提交接口）
3. 分析是否可以通过修改阳光跑数据来模拟自由跑效果